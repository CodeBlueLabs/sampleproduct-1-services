resource_types:
- name: slack-notification
  type: docker-image
  source:
    repository: ((slack.repository))
    tag: ((slack.tag))

resources:
- name: PAL-Immersion-Services
  type: git
  source:
    uri: https://github.com/onedigitaladmin/PAL-Immersion-Services.git
    branch: master
    username: OneDigitalAdmin
    password: pass1234

- name: im-notify
  type: slack-notification
  source:
    url: ((slack.url))

- name: deployapp
  type: cf
  source:
    api: https://api.run.pivotal.io
    username: onedigitaladmin@cognizant.com
    password: Pass123$
    organization: Autoloan
    space: PALImmersion
    skip_cert_check: false

jobs:
- name: Compile
  public: true
  plan:
  - get: PAL-Immersion-Services
    trigger: true
  - task: compile
    file: PAL-Immersion-Services/ci/compile.yml
    on_success:
      put: im-notify
      params:
        channel: ((slack.channel))
        text: |
         *Code Compile* completed successfully without any issues
    on_failure:
      put: im-notify
      params:
        channel: ((slack.channel))
        text: |
         *Code Compile* failed with *compilation error(s)*, check the build log for details
- name: Unit Test
  serial: true
  plan:
  - get: PAL-Immersion-Services
    passed: ['Compile']
    trigger: true
  - task: unittest
    file: PAL-Immersion-Services/ci/test.yml
    on_success:
      put: im-notify
      params:
        channel: ((slack.channel))
        text: |
          *Unit Test* completed successfully
    on_failure:
      put: im-notify
      params:
        channel: ((slack.channel))
        text: |
          *Unit Test* failed with test case failures, check the build log for details
- name: Build
  serial: true
  plan:
  - get: PAL-Immersion-Services
    passed: ['Unit Test']
    trigger: true
  - task: build
    file: PAL-Immersion-Services/ci/build.yml
    on_success:
      put: im-notify
      params:
        channel: ((slack.channel))
        text: |
          *Build* completed successfully
    on_failure:
      put: im-notify
      params:
        channel: ((slack.channel))
        text: |
          *Build* failed, check the build log for details
- name: Deploy
  serial: true
  plan:
  - get: PAL-Immersion-Services
    passed: ['Build']
    trigger: true
  - put: deployapp
    params:
      manifest: PAL-Immersion-Services/manifest.yml
    on_success:
      put: im-notify
      params:
        channel: ((slack.channel))
        text: |
          *Deploy* completed successfully
    on_failure:
      put: im-notify
      params:
        channel: ((slack.channel))
        text: |
          *Deploy* failed, check the build log for details
